<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title></title>
  <meta charset=utf-8 />
  <title>A simple map</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />
  <style>
    body {
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: none;
    }
    .header{
      width: 100%;
      height: 50px;
      box-sizing: border-box;
      padding: 10px 0;
      box-shadow: 0 0 5px #ccc;
      position: relative;
      z-index: 2;
    }
    .logo{
      background: url("img/logo.png") no-repeat center center / contain;
      height: 30px;
      width: 100%;
    }

    .rankings{
      width: 100%;
      height: 164px;
      position: absolute;
      top: 50px;
      overflow-y: auto;
    }
    .title{
      font-size: 16px;
      line-height: 40px;
      border-bottom: 1px solid #ccc;
      box-sizing: border-box;
      padding: 0px 20px;
      position: relative;
    }
    .title:after{
      content: "";
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 10px 10px 0 10px;
      border-color: #ee8a65 transparent transparent transparent;
      position: absolute;
      right: 20px;
      top: 13px;
    }
    .search-title{
      font-size: 16px;
      text-align: center;
      padding: 10px 0;
      box-shadow: 0 0 3px #ccc;
      background-color: #f8f8f8;
    }
    .rankings{
      font-size: 14px;
    }
    .ranking{
      padding: 0;
      margin: 0;
    }
    .hidden{
      display: none;
    }
    .item{
      list-style: none;
      width: 100%;
      font-size: 0;
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    .item:nth-child(even){
      background-color: rgba(126,188,31,.1);
    }
    .item-name,.price,.size{
      display: inline-block;
      font-weight: 300;
      font-size: 14px;
      color: #333;
      width: 33.33%;
      padding: 0;
      margin: 0;
      line-height: 1.5;
    }

    #map { 
      position: absolute; 
      bottom: 0; 
      width: 100%; 
      height: calc(100% - 214px); 
    }

    .popup {
      text-align:center;
    }
    .popup .slideshow .image        { display:none; }
    .popup .slideshow .image.active { display:block; }
    .popup .slideshow img {
      width:100%;
    }
    .popup .slideshow .caption {
      background:#eee;
      padding:10px;
    }
    .popup .cycle {
      padding:10px 0 20px;
    }

  </style>
</head>
<body>
<script>
  uid = "<%=@uid%>";
  loginPic = '';
  console.log(uid);
  var CDN_URL = "<%= CDN_URL %>";
  var CLIENT_URL = "<%= MEEHOME_CLIENT_URL %>";
</script>

  <div class="header">
    <div class="logo"></div>
  </div>
  <div class="rankings">
    <div class="chinese-area area">
      <div class="title">华人最多的城市</div>
      <ul class="chinese-ranking ranking hidden">
        <li class="item">
          <h3 class="item-name">城市</h3>
          <p class="price">均价</p>
          <p class="size">面积</p>
        </li>
        <li class="item">
          <h3 class="item-name">Foster City</h3>
          <p class="price">130万美金</p>
          <p class="size">114平方米</p>
          <button onclick="regionSelect('foster')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('foster')">加入条件搜索</button>
          <% end %>
        </li>
        <li class="item">
          <h3 class="item-name">Mountain View</h3>
          <p class="price">120万美金</p>
          <p class="size">124平方米</p>
          <button onclick="regionSelect('mountain')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('mountain')">加入条件搜索</button>
          <% end %>
        </li>
        <li class="item">
          <h3 class="item-name">San Jose</h3>
          <p class="price">108万美金</p>
          <p class="size">132平方米</p>
          <button onclick="regionSelect('jose')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('jose')">加入条件搜索</button>
          <% end %>
        </li>
      </ul>
    </div>

    <div class="wealth-area area">
      <div class="title">最有钱的社区</div>
      <ul class="wealth-ranking ranking hidden">
        <li class="item">
          <h3 class="item-name">城市</h3>
          <p class="price">均价</p>
          <p class="size">面积</p>
        </li>
        <li class="item">
          <h3 class="item-name">Atherton</h3>
          <p class="price">680万美金</p>
          <p class="size">143平方米</p>
          <button onclick="regionSelect('atherton')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('atherton')">加入条件搜索</button>
          <% end %>
        </li>
        <li class="item">
          <h3 class="item-name">Palo Alto</h3>
          <p class="price">642万美金</p>
          <p class="size">154平方米</p>
          <button onclick="regionSelect('palo')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('palo')">加入条件搜索</button>
          <% end %>
        </li>
        <li class="item">
          <h3 class="item-name">Hillsborough</h3>
          <p class="price">528万美金</p>
          <p class="size">234平方米</p>
          <button onclick="regionSelect('hillsborough')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('hillsborough')">加入条件搜索</button>
          <% end %>
        </li>
      </ul>
    </div>

    <div class="tech-area area">
      <div class="title">科技公司的集中地</div>
      <ul class="tech-ranking ranking hidden">
        <li class="item">
          <h3 class="item-name">城市</h3>
          <p class="price">均价</p>
          <p class="size">面积</p>
        </li>
        <li class="item">
          <h3 class="item-name">San Jose</h3>
          <p class="price">123万美金</p>
          <p class="size">113平方米</p>
          <button onclick="regionSelect('jose')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('jose')">加入条件搜索</button>
          <% end %>
        </li>
        <li class="item">
          <h3 class="item-name">Mountain View</h3>
          <p class="price">120万美金</p>
          <p class="size">124平方米</p>
          <button onclick="regionSelect('mountain')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="addSearch('mountain')">加入条件搜索</button>
          <% end %>
        </li>
        <li class="item">
          <h3 class="item-name">San Francisco</h3>
          <p class="price">248万美金</p>
          <p class="size">132平方米</p>
          <button onclick="regionSelect('francisco')">查看地图</button>
          <% if @uid.present? %>
            <button onclick="regionSelect('francisco')">加入条件搜索</button>
          <% end %>
        </li>
      </ul>
    </div>
  </div>
  <div id='map'></div>
  <script>

    var geoJson = {
      foster: 'Foster City',
      palo: 'Palo Alto',
      mountain: 'Mountain View',
      francisco: 'San Francisco',
      jose: 'San Jose',
      hillsborough: 'Hillsborough',
      atherton: 'Atherton',
      chinese: 'Foster City, Fremont, Union City',
      wealthy: 'Palo Alto, Los Altos',
      tech: 'Mountain View, Sunnyvale'
    };

    L.mapbox.accessToken = 'pk.eyJ1IjoiZGV1Ym95IiwiYSI6ImNpcDg3cm1xMzAxN3VzeW5vdWd6YWx4c2IifQ.cU1CJ-BMZuoyHigylGe4gA';
    map = L.mapbox.map('map', 'mapbox.streets').setView([37.5483, -121.9886], 10);
    var markers = new L.MarkerClusterGroup();

    function addSearch(city) {
      $.ajax({
        url: '/agent/add_customer_search',
        type: 'post',
        dataType: 'json',

        data: JSON.stringify(
            {customer_id: uid, regionValue: geoJson[city] , priceMin: 50.0, priceMax: 300.0}
        ),

        success: function(data) {
         console.log('suggess')
        },
        error: function() {
        }
      });
    }

    function regionSelect(region) {
      markers.clearLayers();

      $.ajax({
        url: '/homeSearch',
        data: {regionValue: geoJson[region] , priceMin: 50.0, priceMax: 300.0, limit: 300, shorten: true},
        type: 'get',

        success: function(data) {
          var homes = JSON.parse(data);
          var long, lat, marker;
          map.setView([37.5483, -121.9886], 10);
          for(var i = 0; i < homes.length; i++) {
            var home = homes[i];
            var image_url = '';
            if(home.images.length > 0 && home.images[0] != undefined){
              image_url = CDN_URL + 'photo/' + home.images[0].image_url
            }
            lat = home.geo_point.split(',')[0];
            long = home.geo_point.split(',')[1];

            marker = L.marker(new L.LatLng(lat, long), {
              icon: L.mapbox.marker.icon({'marker-symbol': 'warehouse', 'marker-color': '0044FF'}),
            });

            var slideshowContent = '';

            slideshowContent += '<div class="image active">' +
                '<img src="' + image_url + '" />' +
                '<div class="caption">' + home.short_desc + '</div>' +
                '</div>';

            // Create custom popup content
            var popupContent =  '<div id="' + home.id + '" class="popup">' +
                '<a href="' + CLIENT_URL + '/home/' + home.id + '">' +
                '<h2>' + home.addr1 + '</h2>' + '</a>' +
                '<div class="slideshow">' +
                slideshowContent +
                '</div>' +
                '</div>';

            marker.bindPopup(popupContent, {
              closeButton: false,
              minWidth: 320
            });

            markers.addLayer(marker);

          }
          map.addLayer(markers);
          map.setView([lat, long], map.getZoom() + 1);
        },
        error: function(data) {

        }
      });

    };

    $('.title').click(function(e){
      var target = $(e.target);
      var list = target.parent('.area');
      var isHide = $('.ranking').hasClass('hidden');
      console.log(isHide);
      if (isHide) {
        list.children('.ranking').removeClass('hidden');
      } else {
        list.children('.ranking').addClass('hidden');
      }
    });
  </script>
</body>
</html>